[{"_path":"/blog/creer-une-collection-ansible-redis-avec-molecule","_dir":"blog","_draft":false,"_partial":false,"_locale":"","_empty":false,"title":"Créer une collection Ansible Redis avec Molecule","description":"Découvrez comment utiliser Ansible et Molecule pour créer rapidement et efficacement une collection personnalisée pour Redis.","img":"/post-thumbnail-01.jpg","tags":["Infrastructure-as-Code","Ansible","Dev"],"createdAt":"2021-04-13T00:00:00.000Z","updatedAt":null,"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Si vous êtes à la recherche d'un moyen pour automatiser l'installation et la configuration d'un cluster Redis, Ansible est un excellent choix. Dans cet article, nous allons voir comment créer une nouvelle "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"collection Ansible"}]},{"type":"text","value":" pour l'installation et la configuration d'un "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"cluster Redis"}]},{"type":"text","value":" en utilisant "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Ansible Galaxy"}]},{"type":"text","value":" et "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Molecule"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Ce dont vous avez besoin\nAvant de commencer, vous devez installer Ansible Galaxy et Molecule. Si vous ne les avez pas encore installés, voici comment procéder :"}]},{"type":"element","tag":"code","props":{"className":["language-undefined"],"code":"# Installation d'Ansible Galaxy\n$ sudo apt-get install ansible-galaxy\n\n# Installation de Molecule\n$ pip install molecule\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# Installation d'Ansible Galaxy\n$ sudo apt-get install ansible-galaxy\n\n# Installation de Molecule\n$ pip install molecule\n"}]}]}]},{"type":"element","tag":"h2","props":{"id":"étape-1-création-de-la-collection-ansible"},"children":[{"type":"text","value":"Étape 1 : Création de la collection Ansible"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"La première étape consiste à créer une nouvelle collection Ansible à l'aide de la commande ansible-galaxy collection init."}]},{"type":"element","tag":"code","props":{"className":["language-undefined"],"code":"$ ansible-galaxy collection init my_redis_cluster\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"$ ansible-galaxy collection init my_redis_cluster\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"La commande créera une nouvelle collection nommée "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"my_redis_cluster"}]},{"type":"text","value":" avec un ensemble de fichiers et de dossiers. Nous allons travailler principalement dans les dossiers roles et molecule de la collection."}]},{"type":"element","tag":"h2","props":{"id":"étape-2-création-du-rôle-ansible"},"children":[{"type":"text","value":"Étape 2 : Création du rôle Ansible"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"La prochaine étape consiste à créer un nouveau rôle à l'intérieur de la collection. Nous allons utiliser Molecule pour créer la structure de notre rôle."}]},{"type":"element","tag":"code","props":{"className":["language-undefined"],"code":"$ cd my_redis_cluster/roles\n$ molecule init role -r redis_cluster\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"$ cd my_redis_cluster/roles\n$ molecule init role -r redis_cluster\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"La commande ci-dessus créera un nouveau rôle nommé "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"redis_cluster"}]},{"type":"text","value":" à l'intérieur de notre collection. La commande créera également une structure de dossier initiale pour le rôle."}]},{"type":"element","tag":"h2","props":{"id":"étape-3-écriture-du-code"},"children":[{"type":"text","value":"Étape 3 : Écriture du code"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Nous sommes maintenant prêts à écrire le code pour notre rôle. Ouvrez le fichier "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"tasks/main.yml"}]},{"type":"text","value":" dans le dossier "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"roles/redis_cluster"}]},{"type":"text","value":" et ajoutez la tâche suivante pour installer Redis :"}]},{"type":"element","tag":"code","props":{"className":["language-undefined"],"code":"- name: Install Redis\n  apt:\n    name: redis\n    state: present\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"- name: Install Redis\n  apt:\n    name: redis\n    state: present\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Ensuite, ouvrez le fichier "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"defaults/main.yml"}]},{"type":"text","value":" et ajoutez les variables suivantes pour configurer Redis :"}]},{"type":"element","tag":"code","props":{"className":["language-undefined"],"code":"redis_port: 6379\nredis_bind: 127.0.0.1\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"redis_port: 6379\nredis_bind: 127.0.0.1\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Dans le fichier "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"templates/redis.conf.j2"}]},{"type":"text","value":", ajoutez la configuration suivante :"}]},{"type":"element","tag":"code","props":{"className":["language-undefined"],"code":"port {{ redis_port }}\nbind {{ redis_bind }}\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"port {{ redis_port }}\nbind {{ redis_bind }}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Enfin, modifiez le fichier "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"tasks/main.yml"}]},{"type":"text","value":" pour appliquer la configuration à Redis :"}]},{"type":"element","tag":"code","props":{"className":["language-undefined"],"code":"- name: Configure Redis\n  template:\n    src: redis.conf.j2\n    dest: /etc/redis/redis.conf\n  notify: Restart Redis\n\n- name: Restart Redis\n  service:\n    name: redis\n    state: restarted\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"- name: Configure Redis\n  template:\n    src: redis.conf.j2\n    dest: /etc/redis/redis.conf\n  notify: Restart Redis\n\n- name: Restart Redis\n  service:\n    name: redis\n    state: restarted\n"}]}]}]},{"type":"element","tag":"h2","props":{"id":"étape-4-tests-avec-molecule"},"children":[{"type":"text","value":"Étape 4 : Tests avec Molecule"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Il est maintenant temps de tester notre rôle avec Molecule. Nous allons utiliser la commande molecule test pour lancer les tests d'"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"idempotence"}]},{"type":"text","value":"."}]},{"type":"element","tag":"code","props":{"className":["language-undefined"],"code":"$ cd ../molecule/default\n$ molecule test\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"$ cd ../molecule/default\n$ molecule test\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"La commande ci-dessus va créer une machine virtuelle, appliquer notre rôle Ansible et vérifier que tout fonctionne correctement. Si tout est OK, vous devriez voir un message comme celui-ci :"}]},{"type":"element","tag":"code","props":{"className":["language-undefined"],"code":"    PLAY RECAP *********************************************************************\n    instance                   : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0\n\n"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"    PLAY RECAP *********************************************************************\n    instance                   : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0\n\n"}]}]}]},{"type":"element","tag":"h2","props":{"id":"conclusion"},"children":[{"type":"text","value":"Conclusion"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Dans cet article, nous avons vu comment créer une nouvelle collection Ansible pour l'installation et la configuration d'un cluster Redis en utilisant Ansible Galaxy et Molecule. Nous avons utilisé Ansible pour installer Redis et configuré les variables à l'aide de fichiers de configuration Jinja2. Nous avons également utilisé Molecule pour tester notre rôle Ansible et vérifier qu'il fonctionne correctement. Vous pouvez maintenant utiliser cette collection Ansible pour automatiser l'installation et la configuration de votre propre cluster Redis."}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"étape-1-création-de-la-collection-ansible","depth":2,"text":"Étape 1 : Création de la collection Ansible"},{"id":"étape-2-création-du-rôle-ansible","depth":2,"text":"Étape 2 : Création du rôle Ansible"},{"id":"étape-3-écriture-du-code","depth":2,"text":"Étape 3 : Écriture du code"},{"id":"étape-4-tests-avec-molecule","depth":2,"text":"Étape 4 : Tests avec Molecule"},{"id":"conclusion","depth":2,"text":"Conclusion"}]}},"_type":"markdown","_id":"content:blog:creer-une-collection-ansible-redis-avec-molecule.md","_source":"content","_file":"blog/creer-une-collection-ansible-redis-avec-molecule.md","_extension":"md"},{"_path":"/blog/testez-votre-infrastructure-avec-terratest","_dir":"blog","_draft":false,"_partial":false,"_locale":"","_empty":false,"title":"Améliorez la robustesse de votre infrastructure avec Terratest.","description":"Découvrez comment Terratest peut renforcer la solidité et la fiabilité de votre infrastructure.","img":"/terratest.jpeg","tags":["Infrastructure-as-Code","Terraform","Dev"],"createdAt":"2021-08-07T00:00:00.000Z","updatedAt":null,"body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Lorsqu'il s'agit de créer une infrastructure as code solide et fiable, il est essentiel de s'assurer que votre code fonctionne correctement avant de le déployer en production. C'est là que Terratest entre en jeu en vous offrant un outil puissant pour les tests d'infrastructure. Dans cet article, nous allons découvrir comment Terratest peut renforcer la solidité et la fiabilité de votre infrastructure Terraform, vous permettant ainsi de développer et déployer une infrastructure résiliente."}]},{"type":"element","tag":"h2","props":{"id":"les-avantages-des-tests-dinfrastructure-avec-terratest"},"children":[{"type":"text","value":"Les avantages des tests d'infrastructure avec Terratest"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Terratest est un outil avancé qui vous permet de tester votre infrastructure as code de manière approfondie. Voici pourquoi l'utilisation de Terratest peut être bénéfique pour votre organisation :"}]},{"type":"element","tag":"h3","props":{"id":"_1-tests-didempotence"},"children":[{"type":"text","value":"1. Tests d'idempotence"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"L'un des aspects clés des tests d'infrastructure est l'idempotence, c'est-à-dire la capacité du code à produire le même résultat, peu importe le nombre de fois qu'il est exécuté. Terratest facilite les tests d'idempotence en vous permettant de vérifier si votre infrastructure est correctement provisionnée et qu'aucun changement n'est apporté lorsque vous exécutez le code plusieurs fois. Cela garantit que votre infrastructure est stable et prévisible, éliminant les problèmes potentiels lors des déploiements."}]},{"type":"element","tag":"h3","props":{"id":"_2-tests-automatisés-avancés"},"children":[{"type":"text","value":"2. Tests automatisés avancés"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Terratest offre un large éventail de fonctionnalités pour automatiser vos tests d'infrastructure. Vous pouvez écrire des scripts de test en utilisant des langages familiers tels que Go, Python ou Shell, et exécuter ces tests de manière automatisée. Cela vous permet d'économiser du temps précieux en réduisant les tâches manuelles et en minimisant les erreurs humaines lors des tests."}]},{"type":"element","tag":"h3","props":{"id":"_3-intégration-transparente-avec-terraform"},"children":[{"type":"text","value":"3. Intégration transparente avec Terraform"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Terratest s'intègre parfaitement avec Terraform, l'outil populaire pour la création d'infrastructures as code. Vous pouvez utiliser Terratest pour valider votre code Terraform avant de le déployer, ce qui vous permet de détecter et corriger les éventuelles erreurs avant qu'elles ne causent des problèmes dans votre environnement de production. Cette intégration transparente favorise la collaboration entre les développeurs et les opérations, en assurant un déploiement harmonieux de l'infrastructure."}]},{"type":"element","tag":"h2","props":{"id":"préparez-vous-à-développer-une-infrastructure-résiliente-avec-terratest"},"children":[{"type":"text","value":"Préparez-vous à développer une infrastructure résiliente avec Terratest"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Maintenant que vous avez compris les nombreux avantages de Terratest, il est temps de préparer votre infrastructure à être résiliente et de qualité. Voici quelques suggestions pour commencer :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"Familiarisez-vous avec Terratest :"}]},{"type":"text","value":" Explorez la documentation officielle de Terratest et recherchez des exemples de tests d'infrastructure pour vous familiariser avec les différentes fonctionnalités de l'outil."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"Écrivez des tests d'idempotence :"}]},{"type":"text","value":" Identifiez les parties clés de votre infrastructure et écrivez des tests pour vérifier si elles sont idempotentes. Cela vous permettra de garantir la stabilité de votre infrastructure lors des déploiements."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"Automatisez vos tests :"}]},{"type":"text","value":" Utilisez les scripts de test de Terratest pour automatiser vos tests d'infrastructure. Configurez des pipelines d'intégration continue pour exécuter ces tests à chaque changement de code, assurant ainsi une validation régulière de votre infrastructure as code."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"Expérimentez avec d'autres fonctionnalités de Terratest :"}]},{"type":"text","value":" Terratest offre de nombreuses autres fonctionnalités avancées, telles que la vérification des ressources Terraform, les tests de sécurité et les tests de performance. Expérimentez avec ces fonctionnalités supplémentaires pour renforcer davantage la fiabilité de votre infrastructure."}]},{"type":"element","tag":"h2","props":{"id":"exemple-de-code-terraform-azure-avec-un-load-balancer-et-des-vmss-linux"},"children":[{"type":"text","value":"Exemple de code Terraform Azure avec un load balancer et des VMSS Linux"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Voici un exemple de code Terraform pour créer un load balancer avec une Virtual Machine Scale Set (VMSS) Linux dans Microsoft Azure :"}]},{"type":"element","tag":"code","props":{"className":["language-hcl"],"code":"# exemple/main.tf\n\nprovider \"azurerm\" {\n  version = \"~> 2.0\"\n  features {}\n}\n\nresource \"azurerm_resource_group\" \"example\" {\n  name     = \"example-rg\"\n  location = \"West Europe\"\n}\n\nresource \"azurerm_virtual_network\" \"example\" {\n  name                = \"example-vnet\"\n  address_space       = [\"10.0.0.0/16\"]\n  location            = azurerm_resource_group.example.location\n  resource_group_name = azurerm_resource_group.example.name\n}\n\nresource \"azurerm_subnet\" \"example\" {\n  name                 = \"example-subnet\"\n  resource_group_name  = azurerm_resource_group.example.name\n  virtual_network_name = azurerm_virtual_network.example.name\n  address_prefixes     = [\"10.0.1.0/24\"]\n}\n\nresource \"azurerm_public_ip\" \"example\" {\n  name                = \"example-ip\"\n  resource_group_name = azurerm_resource_group.example.name\n  location            = azurerm_resource_group.example.location\n  allocation_method   = \"Static\"\n}\n\nresource \"azurerm_lb\" \"example\" {\n  name                = \"example-lb\"\n  resource_group_name = azurerm_resource_group.example.name\n  location            = azurerm_resource_group.example.location\n  sku                 = \"Standard\"\n\n  frontend_ip_configuration {\n    name                 = \"example-front-ip\"\n    public_ip_address_id = azurerm_public_ip.example.id\n  }\n}\n\nresource \"azurerm_lb_backend_address_pool\" \"example\" {\n  name                = \"example-backend-pool\"\n  resource_group_name = azurerm_resource_group.example.name\n  loadbalancer_id     = azurerm_lb.example.id\n}\n\nresource \"azurerm_lb_rule\" \"example\" {\n  name                           = \"example-lb-rule\"\n  resource_group_name            = azurerm_resource_group.example.name\n  loadbalancer_id                = azurerm_lb.example.id\n  frontend_ip_configuration_name = azurerm_lb.example.frontend_ip_configuration[0].name\n  backend_address_pool_id        = azurerm_lb_backend_address_pool.example.id\n  protocol                       = \"Tcp\"\n  frontend_port                  = 80\n  backend_port                   = 80\n  enable_floating_ip             = true\n}\n\nresource \"azurerm_virtual_machine_scale_set\" \"example\" {\n  name                = \"example-vmss\"\n  resource_group_name = azurerm_resource_group.example.name\n  location            = azurerm_resource_group.example.location\n  sku                 = \"Standard_DS2_v2\"\n  instances           = 3\n\n  upgrade_mode                                      = \"Manual\"\n  health_probe_id                                   = azurerm_lb.example.probes[0].id\n  single_placement_group                            = false\n  platform_fault_domain_count                       = 2\n  platform_update_domain_count                      = 2\n  termination_mode                                  = \"Default\"\n\n  storage_profile_image_reference {\n    publisher = \"Canonical\"\n    offer     = \"UbuntuServer\"\n    sku       = \"16.04-LTS\"\n    version   = \"latest\"\n  }\n\n  storage_profile_os_disk {\n    name              = \"example-osdisk\"\n    caching           = \"ReadWrite\"\n    create_option     = \"FromImage\"\n    managed_disk_type = \"Standard_LRS\"\n  }\n\n  os_profile {\n    computer_name_prefix = \"example-vm\"\n    admin_username       = \"adminuser\"\n    admin_password       = \"P@ssw0rd1234\"\n  }\n\n  network_profile {\n    name = \"example-network-profile\"\n    network_interface {\n      name    = \"example-nic\"\n      primary = true\n\n      ip_configuration {\n        name                          = \"example-ip-config\"\n        subnet_id                     = azurerm_subnet.example.id\n        private_ip_address_allocation = \"Dynamic\"\n        load_balancer_backend_address_pool_ids = [\n          azurerm_lb_backend_address_pool.example.id\n        ]\n      }\n    }\n  }\n}\n","language":"hcl","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# exemple/main.tf\n\nprovider \"azurerm\" {\n  version = \"~> 2.0\"\n  features {}\n}\n\nresource \"azurerm_resource_group\" \"example\" {\n  name     = \"example-rg\"\n  location = \"West Europe\"\n}\n\nresource \"azurerm_virtual_network\" \"example\" {\n  name                = \"example-vnet\"\n  address_space       = [\"10.0.0.0/16\"]\n  location            = azurerm_resource_group.example.location\n  resource_group_name = azurerm_resource_group.example.name\n}\n\nresource \"azurerm_subnet\" \"example\" {\n  name                 = \"example-subnet\"\n  resource_group_name  = azurerm_resource_group.example.name\n  virtual_network_name = azurerm_virtual_network.example.name\n  address_prefixes     = [\"10.0.1.0/24\"]\n}\n\nresource \"azurerm_public_ip\" \"example\" {\n  name                = \"example-ip\"\n  resource_group_name = azurerm_resource_group.example.name\n  location            = azurerm_resource_group.example.location\n  allocation_method   = \"Static\"\n}\n\nresource \"azurerm_lb\" \"example\" {\n  name                = \"example-lb\"\n  resource_group_name = azurerm_resource_group.example.name\n  location            = azurerm_resource_group.example.location\n  sku                 = \"Standard\"\n\n  frontend_ip_configuration {\n    name                 = \"example-front-ip\"\n    public_ip_address_id = azurerm_public_ip.example.id\n  }\n}\n\nresource \"azurerm_lb_backend_address_pool\" \"example\" {\n  name                = \"example-backend-pool\"\n  resource_group_name = azurerm_resource_group.example.name\n  loadbalancer_id     = azurerm_lb.example.id\n}\n\nresource \"azurerm_lb_rule\" \"example\" {\n  name                           = \"example-lb-rule\"\n  resource_group_name            = azurerm_resource_group.example.name\n  loadbalancer_id                = azurerm_lb.example.id\n  frontend_ip_configuration_name = azurerm_lb.example.frontend_ip_configuration[0].name\n  backend_address_pool_id        = azurerm_lb_backend_address_pool.example.id\n  protocol                       = \"Tcp\"\n  frontend_port                  = 80\n  backend_port                   = 80\n  enable_floating_ip             = true\n}\n\nresource \"azurerm_virtual_machine_scale_set\" \"example\" {\n  name                = \"example-vmss\"\n  resource_group_name = azurerm_resource_group.example.name\n  location            = azurerm_resource_group.example.location\n  sku                 = \"Standard_DS2_v2\"\n  instances           = 3\n\n  upgrade_mode                                      = \"Manual\"\n  health_probe_id                                   = azurerm_lb.example.probes[0].id\n  single_placement_group                            = false\n  platform_fault_domain_count                       = 2\n  platform_update_domain_count                      = 2\n  termination_mode                                  = \"Default\"\n\n  storage_profile_image_reference {\n    publisher = \"Canonical\"\n    offer     = \"UbuntuServer\"\n    sku       = \"16.04-LTS\"\n    version   = \"latest\"\n  }\n\n  storage_profile_os_disk {\n    name              = \"example-osdisk\"\n    caching           = \"ReadWrite\"\n    create_option     = \"FromImage\"\n    managed_disk_type = \"Standard_LRS\"\n  }\n\n  os_profile {\n    computer_name_prefix = \"example-vm\"\n    admin_username       = \"adminuser\"\n    admin_password       = \"P@ssw0rd1234\"\n  }\n\n  network_profile {\n    name = \"example-network-profile\"\n    network_interface {\n      name    = \"example-nic\"\n      primary = true\n\n      ip_configuration {\n        name                          = \"example-ip-config\"\n        subnet_id                     = azurerm_subnet.example.id\n        private_ip_address_allocation = \"Dynamic\"\n        load_balancer_backend_address_pool_ids = [\n          azurerm_lb_backend_address_pool.example.id\n        ]\n      }\n    }\n  }\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Dans cet exemple, nous avons créé une ressource de groupe Azure (Resource Group) dans la région Ouest de l'Europe. Ensuite, nous avons créé un réseau virtuel (Virtual Network) avec un sous-réseau (Subnet). Nous avons également créé une adresse IP publique (Public IP) et un équilibreur de charge (Load Balancer). Le load balancer est configuré avec une règle pour rediriger le trafic vers trois machines virtuelles (VMSS)."}]},{"type":"element","tag":"h2","props":{"id":"exemple-de-code-terratest"},"children":[{"type":"text","value":"Exemple de code Terratest"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Bien sûr ! Voici un exemple de code Terratest pour vérifier l'infrastructure décrite précédemment :"}]},{"type":"element","tag":"code","props":{"className":["language-go"],"code":"# terratest/default_test.go\n\npackage test\n\nimport (\n    \"os\"\n    \"testing\"\n    \"time\"\n\n    \"github.com/gruntwork-io/terratest/modules/azure\"\n    \"github.com/gruntwork-io/terratest/modules/terraform\"\n    test_structure \"github.com/gruntwork-io/terratest/modules/test-structure\"\n    \"github.com/stretchr/testify/assert\"\n)\n\nfunc TestEndToEndDeploymentScenario(t *testing.T) {\n\n    fixtureFolder := \"../example\"\n\n    // Variables à transmettre à notre code Terraform en utilisant les options -var\n    vars := map[string]interface{}{\n        \"tenant_id\":       os.Getenv(\"ARM_TENANT_ID\"),\n        \"subscription_id\": os.Getenv(\"ARM_SUBSCRIPTION_ID\"),\n        \"client_id\":       os.Getenv(\"ARM_CLIENT_ID\"),\n        \"client_secret\":   os.Getenv(\"ARM_CLIENT_SECRET\"),\n    }\n\n    // Utiliser Terratest pour déployer l'infrastructure\n    test_structure.RunTestStage(t, \"create\", func() {\n\n        terraformOptions := &terraform.Options{\n            TerraformDir: fixtureFolder,\n            Vars:         vars,\n            Parallelism:  1,\n        }\n\n        // Sauvegarder les options pour les étapes de test ultérieures\n        test_structure.SaveTerraformOptions(t, fixtureFolder, terraformOptions)\n\n        // Déclenche l'initialisation de Terraform et l'application du code\n        terraform.InitAndApply(t, terraformOptions)\n    })\n\n    // Vérifier que le groupe de ressources et la VMSS existent toujours\n    test_structure.RunTestStage(t, \"verify_resources\", func() {\n\n        terraformOptions := test_structure.LoadTerraformOptions(t, fixtureFolder)\n\n        // Récupérer le nom du groupe de ressources et de la VMSS\n        resourceGroupName := terraform.Output(t, terraformOptions, \"resource_group_name\")\n        vmssName := terraform.Output(t, terraformOptions, \"vmss_name\")\n\n        // Vérifier que le groupe de ressources existe toujours\n        azure.AssertResourceGroupExists(t, resourceGroupName)\n\n        // Vérifier que la VMSS existe toujours\n        timeout := time.Minute * 5\n        azure.AssertVirtualMachineScaleSetExists(t, vmssName, resourceGroupName, timeout)\n    })\n\n    // Vérifier l'idempotence de l'infrastructure\n    test_structure.RunTestStage(t, \"idempotence\", func() {\n\n        terraformOptions := test_structure.LoadTerraformOptions(t, fixtureFolder)\n\n        // Déclenche une vérification que la configuration Terraform est idempotente lorsqu'une deuxième\n        // exécution de `terraform apply` ne produit aucun changement\n        terraform.ApplyAndIdempotent(t, terraformOptions)\n    })\n\n    // Après la fin du test, détruire l'infrastructure en appelant `terraform destroy`\n    test_structure.RunTestStage(t, \"destroy\", func() {\n\n        terraformOptions := test_structure.LoadTerraformOptions(t, fixtureFolder)\n\n        // Déclenche la commande `terraform destroy`\n        defer terraform.Destroy(t, terraformOptions)\n    })\n}\n","language":"go","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# terratest/default_test.go\n\npackage test\n\nimport (\n    \"os\"\n    \"testing\"\n    \"time\"\n\n    \"github.com/gruntwork-io/terratest/modules/azure\"\n    \"github.com/gruntwork-io/terratest/modules/terraform\"\n    test_structure \"github.com/gruntwork-io/terratest/modules/test-structure\"\n    \"github.com/stretchr/testify/assert\"\n)\n\nfunc TestEndToEndDeploymentScenario(t *testing.T) {\n\n    fixtureFolder := \"../example\"\n\n    // Variables à transmettre à notre code Terraform en utilisant les options -var\n    vars := map[string]interface{}{\n        \"tenant_id\":       os.Getenv(\"ARM_TENANT_ID\"),\n        \"subscription_id\": os.Getenv(\"ARM_SUBSCRIPTION_ID\"),\n        \"client_id\":       os.Getenv(\"ARM_CLIENT_ID\"),\n        \"client_secret\":   os.Getenv(\"ARM_CLIENT_SECRET\"),\n    }\n\n    // Utiliser Terratest pour déployer l'infrastructure\n    test_structure.RunTestStage(t, \"create\", func() {\n\n        terraformOptions := &terraform.Options{\n            TerraformDir: fixtureFolder,\n            Vars:         vars,\n            Parallelism:  1,\n        }\n\n        // Sauvegarder les options pour les étapes de test ultérieures\n        test_structure.SaveTerraformOptions(t, fixtureFolder, terraformOptions)\n\n        // Déclenche l'initialisation de Terraform et l'application du code\n        terraform.InitAndApply(t, terraformOptions)\n    })\n\n    // Vérifier que le groupe de ressources et la VMSS existent toujours\n    test_structure.RunTestStage(t, \"verify_resources\", func() {\n\n        terraformOptions := test_structure.LoadTerraformOptions(t, fixtureFolder)\n\n        // Récupérer le nom du groupe de ressources et de la VMSS\n        resourceGroupName := terraform.Output(t, terraformOptions, \"resource_group_name\")\n        vmssName := terraform.Output(t, terraformOptions, \"vmss_name\")\n\n        // Vérifier que le groupe de ressources existe toujours\n        azure.AssertResourceGroupExists(t, resourceGroupName)\n\n        // Vérifier que la VMSS existe toujours\n        timeout := time.Minute * 5\n        azure.AssertVirtualMachineScaleSetExists(t, vmssName, resourceGroupName, timeout)\n    })\n\n    // Vérifier l'idempotence de l'infrastructure\n    test_structure.RunTestStage(t, \"idempotence\", func() {\n\n        terraformOptions := test_structure.LoadTerraformOptions(t, fixtureFolder)\n\n        // Déclenche une vérification que la configuration Terraform est idempotente lorsqu'une deuxième\n        // exécution de `terraform apply` ne produit aucun changement\n        terraform.ApplyAndIdempotent(t, terraformOptions)\n    })\n\n    // Après la fin du test, détruire l'infrastructure en appelant `terraform destroy`\n    test_structure.RunTestStage(t, \"destroy\", func() {\n\n        terraformOptions := test_structure.LoadTerraformOptions(t, fixtureFolder)\n\n        // Déclenche la commande `terraform destroy`\n        defer terraform.Destroy(t, terraformOptions)\n    })\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Dans cet exemple, deux tests ont été ajoutés :"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"verify_resources :"}]},{"type":"text","value":" Ce test vérifie que le groupe de ressources et la VMSS existent toujours après le déploiement. Pour cela, nous utilisons les fonctions azure.AssertResourceGroupExists et azure.AssertVirtualMachineScaleSetExists pour effectuer les vérifications nécessaires."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"idempotence :"}]},{"type":"text","value":" Ce test vérifie toujours l'idempotence de l'infrastructure, comme mentionné précédemment."}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"N'oubliez pas d'ajuster le chemin du dossier fixtureFolder pour correspondre à votre propre configuration Terraform, et de configurer les variables d'environnement nécessaires. Vous pouvez exécuter ce test en utilisant la commande go test -v dans le répertoire contenant le fichier de test."}]}]},{"type":"element","tag":"h2","props":{"id":"conclusion"},"children":[{"type":"text","value":"Conclusion"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"L'utilisation de Terratest avec l'intégration de Terraform offre un moyen efficace de tester votre code d'infrastructure et d'automatiser les tests de bout en bout pour garantir la stabilité de votre environnement."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Continuez à explorer les fonctionnalités de Terratest et Terraform pour améliorer davantage votre processus de test et garantir la qualité de votre code d'infrastructure."}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"les-avantages-des-tests-dinfrastructure-avec-terratest","depth":2,"text":"Les avantages des tests d'infrastructure avec Terratest","children":[{"id":"_1-tests-didempotence","depth":3,"text":"1. Tests d'idempotence"},{"id":"_2-tests-automatisés-avancés","depth":3,"text":"2. Tests automatisés avancés"},{"id":"_3-intégration-transparente-avec-terraform","depth":3,"text":"3. Intégration transparente avec Terraform"}]},{"id":"préparez-vous-à-développer-une-infrastructure-résiliente-avec-terratest","depth":2,"text":"Préparez-vous à développer une infrastructure résiliente avec Terratest"},{"id":"exemple-de-code-terraform-azure-avec-un-load-balancer-et-des-vmss-linux","depth":2,"text":"Exemple de code Terraform Azure avec un load balancer et des VMSS Linux"},{"id":"exemple-de-code-terratest","depth":2,"text":"Exemple de code Terratest"},{"id":"conclusion","depth":2,"text":"Conclusion"}]}},"_type":"markdown","_id":"content:blog:testez-votre-infrastructure-avec-terratest.md","_source":"content","_file":"blog/testez-votre-infrastructure-avec-terratest.md","_extension":"md"}]